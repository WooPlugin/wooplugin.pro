---
interface Props {
  src: string;
  alt: string;
  caption?: string;
  lightbox?: boolean;
}

const { src, alt, caption, lightbox = true } = Astro.props;
const uniqueId = `screenshot-${Math.random().toString(36).substr(2, 9)}`;
---

<figure class="my-6">
  {lightbox ? (
    <>
      <button
        type="button"
        class="block w-full cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-lg"
        data-lightbox-trigger={uniqueId}
      >
        <img
          src={src}
          alt={alt}
          class="w-full rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow"
          loading="lazy"
        />
      </button>

      <!-- Lightbox -->
      <dialog id={uniqueId} class="lightbox-dialog">
        <div class="lightbox-backdrop" data-lightbox-close>
          <button
            type="button"
            class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10"
            data-lightbox-close
          >
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <img
            src={src}
            alt={alt}
            class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl"
          />
        </div>
      </dialog>
    </>
  ) : (
    <img
      src={src}
      alt={alt}
      class="w-full rounded-lg shadow-md border border-gray-200"
      loading="lazy"
    />
  )}
  {caption && (
    <figcaption class="mt-2 text-center text-sm text-text-muted">
      {caption}
    </figcaption>
  )}
</figure>

<style>
  .lightbox-dialog {
    padding: 0;
    border: none;
    background: transparent;
    max-width: 100vw;
    max-height: 100vh;
    width: 100vw;
    height: 100vh;
  }

  .lightbox-dialog::backdrop {
    background: rgba(0, 0, 0, 0.9);
  }

  .lightbox-backdrop {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 2rem;
  }
</style>

<script>
  function initLightboxes() {
    // Handle triggers
    document.querySelectorAll<HTMLButtonElement>('[data-lightbox-trigger]').forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const dialogId = trigger.getAttribute('data-lightbox-trigger');
        const dialog = document.getElementById(dialogId || '') as HTMLDialogElement | null;
        dialog?.showModal();
      });
    });

    // Handle closes
    document.querySelectorAll<HTMLElement>('[data-lightbox-close]').forEach((closer) => {
      closer.addEventListener('click', (e) => {
        const dialog = closer.closest('dialog') as HTMLDialogElement | null;
        if (e.target === closer || closer.tagName === 'BUTTON') {
          dialog?.close();
        }
      });
    });

    // Close on escape
    document.querySelectorAll<HTMLDialogElement>('.lightbox-dialog').forEach((dialog) => {
      dialog.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          dialog.close();
        }
      });
    });
  }

  initLightboxes();
  document.addEventListener('astro:page-load', initLightboxes);
</script>
